---
title: "DHSB Technology Tables"
author: "Adam Northrup, Data Manager, ETAC"
date: "March 11, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
#####Read libraries
library(tidyverse)
library(sjlabelled)
library(rio)
library(openxlsx)
library(kableExtra)

#####Load data
setwd("C:/Users/ANorthrup/Documents/ETAC_DHSB")
load("acasi.RData")
```

```{r}
tech <- acasi2 %>%
  select(SITE1, SITE_RC, PID, starts_with("MTU"), starts_with("S56"))
```

```{r}
x <- tech %>%
  select(SITE1, matches("S56_1[[:alpha:]]+"), -S56_1S)
devices <- tibble(Text = c("Cell phone", "Tablet", "Other mobile device", 
                           "Laptop", "Desktop computer", "Other", 
                           "Not applicable"),
                  Variable = names(x))
freqCols <- x %>% 
  select(-SITE1) %>%
  map_int(sum) %>%
  sort(., decreasing = TRUE) %>%
  names()
x <- x %>%
  mutate(Other = rowSums(select(., freqCols[4:length(freqCols)]))) %>%
  mutate(Other = if_else(Other > 0, 1L, 0L))
tableTech <- function (y) {
  full_join(
    x %>% 
      select(-SITE1) %>%
    {
      bind_cols(map_int(., sum) %>% 
                  as.data.frame() %>%
                  rownames_to_column("Variable"),
                map_dbl(., mean) %>%
                  as.data.frame())
    } %>%
      setNames(c("Variable", "Sum", "Mean")) %>%
      mutate(Mean = scales::percent(Mean, accuracy = 0.1)) %>%
      unite("Value", Sum, Mean, sep = " (") %>%
      mutate(Value = gsub("(.*)", "\\1)", Value)),
    x %>%
      group_by(SITE1) %>%
      summarize_all(funs(sum, mean)) %>%
      gather("Key", "Value", -SITE1) %>%
      {
        full_join(filter(., str_detect(Key, "_sum")) %>%
                    rename(Sum = Value) %>%
                    mutate(Key = gsub("_sum", "", Key)),
                  filter(., str_detect(Key, "_mean")) %>%
                    rename(Mean = Value) %>%
                    mutate(Key = gsub("_mean", "", Key)),
                  by = c("SITE1", "Key"))
      } %>%
      rename(Variable = Key) %>%
      mutate(Mean = scales::percent(Mean, accuracy = 0.1)) %>%
      unite("Value", Sum, Mean, sep = " (") %>%
      mutate(Value = gsub("(.*)", "\\1)", Value)) %>%
      spread(SITE1, Value),
    by = "Variable"
  )
}
x %>%
  group_by(SITE1) %>%
  tableTech()
x %>% 
  select(freqCols[1:3], Other) %>% 
  {
    bind_cols(map_int(., sum) %>% 
                as.data.frame() %>%
                rownames_to_column("Variable"),
              map_dbl(., mean) %>%
                as.data.frame())
  } %>%
  setNames(c("Variable", "Count", "Percent")) %>%
  mutate(Percent = scales::percent(Percent, accuracy = 0.1)) %>%
  unite("Value", Count, Percent, sep = " (") %>%
  mutate(Value = paste0(Value, ")")) %>%
  mutate(Variable = c(devices$Text[
           map_int(Variable[1:3], ~which(devices$Variable %in% .))
           ],
           "Other"))
```