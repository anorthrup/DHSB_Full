---
title: "DHSB Technology Tables"
author: "Adam Northrup, Data Manager, ETAC"
date: "March 11, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
#####Read libraries
library(tidyverse)
library(sjlabelled)
library(rio)
library(openxlsx)
library(kableExtra)

#####Load data
setwd("C:/Users/ANorthrup/Documents/ETAC_DHSB")
load("acasi.RData")
```

```{r processData}
tech <- acasi2 %>%
  select(SITE1, SITE_RC, PID, starts_with("MTU"), starts_with("S56"))
```

```{r techSummaryFunction}
tableTech <- function (x, n, header, variables) {
  ##variables = named vector with names as column names, values as strings
  ##n = number of names to keep, rest will be lumped into 'Other'
  varNames <- names(variables)
  
  #Document non-binary values
  y <- x %>% 
    select(varNames) %>%
    map(~unique(.[!. %in% c(0, 1)])) %>%
    unlist()
  if (any(y > 0)) {
    print("Rows with the following values in the listed columns were removed:")
    print(y)
  }
  
  x <- x %>%
    #Narrow x to only necessary columns
    select(SITE_RC, varNames) %>%
    #Remove rows with non-binary values (refused to answer, skipped)
    filter_if(is.numeric, all_vars(. %in% c(0, 1)))
  #Column totals
  siteN <- x %>%
    {
      bind_cols(
        summarize(., Overall = paste0(n(), " (100.0%)")),
        group_by(., SITE_RC) %>%
          summarize(N = paste0(n(), " (100.0%)")) %>%
          spread(SITE_RC, N)
      )
    } %>%
    mutate(Variable = "Total") %>%
    select(Variable, Overall, `Corpus Christi`, `Los Angeles`, `New York`, 
           Chicago, Cleveland, Hershey, Philadelphia, `San Francisco`, 
           `Winston-Salem`, `St. Louis`)
  #List responses in descending ranked order
  freqCols <- x %>% 
    select(-SITE_RC) %>%
    map_int(sum) %>%
    sort(., decreasing = TRUE) %>%
    names()
  #Combine lower ranked responses if there are more than (n + 1)
  if (length(freqCols) > (n + 1)){
    x <- x %>%
      mutate(Other = rowSums(select(., freqCols[(n + 1):length(freqCols)]))) %>%
      mutate(Other = if_else(Other > 0, 1L, 0L)) %>%
      select(SITE_RC, freqCols[1:n], Other)
    freqCols <- c(freqCols[1:n], "Other")
  }
  #Summarize responses overall and by site
  full_join(
    #Summarize overall
    x %>% 
      select(-SITE_RC) %>%
    {
      bind_cols(map_int(., sum) %>% 
                  as.data.frame() %>%
                  rownames_to_column("Variable"),
                map_dbl(., mean) %>%
                  as.data.frame())
    } %>%
      setNames(c("Variable", "Sum", "Mean")) %>%
      mutate(Mean = scales::percent(Mean, accuracy = 0.1)) %>%
      unite("Overall", Sum, Mean, sep = " (") %>%
      mutate(Overall = gsub("(.*)", "\\1)", Overall)),
    #Summarize by site
    x %>%
      group_by(SITE_RC) %>%
      summarize_all(funs(sum, mean)) %>%
      gather("Key", "Value", -SITE_RC) %>%
      {
        full_join(filter(., str_detect(Key, "_sum")) %>%
                    rename(Sum = Value) %>%
                    mutate(Key = gsub("_sum", "", Key)),
                  filter(., str_detect(Key, "_mean")) %>%
                    rename(Mean = Value) %>%
                    mutate(Key = gsub("_mean", "", Key)),
                  by = c("SITE_RC", "Key"))
      } %>%
      rename(Variable = Key) %>%
      mutate(Mean = scales::percent(Mean, accuracy = 0.1)) %>%
      unite("Value", Sum, Mean, sep = " (") %>%
      mutate(Value = gsub("(.*)", "\\1)", Value)) %>%
      spread(SITE_RC, Value),
    by = "Variable"
  ) %>%
    #Overwrite variable names with readable names
    mutate(Variable = c(
      variables[map_int(Variable[1:n], ~which(varNames %in% .))],
      "Other")) %>%
    #Add totals row
      {
        bind_rows(
          siteN,
          select(., everything())
        )
      } %>%
    add_row(Variable = paste0(header, ", N (%)"),
            Overall = NA, `Corpus Christi` = NA, `Los Angeles` = NA, 
            `New York` = NA, Chicago = NA, Cleveland = NA, Hershey = NA, 
            Philadelphia = NA, `San Francisco` = NA, `Winston-Salem` = NA, 
            `St. Louis` = NA,
            .before = 1)
}
```

```{r techSummary}
table3 <- bind_rows(
  tableTech(tech, n = 3, header = "Device Use",
            variables = c("S56_1A" = "Cell Phone", 
                          "S56_1B" = "Tablet", 
                          "S56_1C" = "Other mobile device",
                          "S56_1D" = "Laptop",
                          "S56_1E" = "Desktop computer",
                          "S56_1F" = "Other", 
                          "S56_1G" = "No devices")),
  tableTech(tech, n = 3, header = "Device Use Locations",
            variables = c("S56_2A" = "Home", 
                          "S56_2B" = "Where I'm staying", 
                          "S56_2C" = "Other's house/apartment", 
                          "S56_2D" = "Public place with WiFi", 
                          "S56_2E" = "Internet cafe", 
                          "S56_2F" = "Public library", 
                          "S56_2G" = "School", 
                          "S56_2H" = "Work", 
                          "S56_2I" = "Other"))
)
```

