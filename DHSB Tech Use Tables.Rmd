---
title: "DHSB Technology Tables"
author: "Adam Northrup, Data Manager, ETAC"
date: "June 6, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
#####Read libraries
library(tidyverse)
library(sjlabelled)
library(rio)
library(openxlsx)
library(kableExtra)

#####Load data
load("acasi.RData")
source("DHSB Table Functions.R")
```

```{r processData}
tech <- acasi %>%
  filter(Set == 1) %>% #Remove participants without 06m assessment
  filter(!(is.na(HE_RC_HAL) | is.na(HE_RC_HSE))) %>%
  select(SITE1, SITE_RC, PID, starts_with("MTU"), starts_with("S56")) %>%
  mutate(S56_3 = fct_recode(as.factor(S56_3),
                            "Have cell phone, minutes, and data"    = "1",
                            "Have cell phone, minutes, and no data" = "2",
                            "Have cell phone, data, and no minutes" = "3",
                            "I share a phone"                       = "4",
                            "Don't have own cell, can borrow one"   = "5",
                            "Don't have own cell, can't borrow one" = "6",
                            "Refuse to answer"                      = "8")) %>%
  mutate_at(vars(one_of("S56_4", "S56_7", "S56_13", "S56_16", "S56_21")), 
            list(~as.factor)) %>%
  mutate_at(vars(one_of("S56_4", "S56_7", "S56_13", "S56_16", "S56_21")), 
            list(~fct_recode),
            "Several times a day"       = "1",
            "Once a day"                = "2",
            "Once every couple of days" = "3",
            "About once a week"         = "4",
            "Less than once a week"     = "5",
            "Never"                     = "6",
            "Refuse to answer"          = "8",
            "Skipped"                   = "9") %>%
  mutate(S56_11 = fct_recode(as.factor(S56_11),
                             "Facebook"           = "0",
                             "Facebook Messenger" = "1",
                             "Twitter"            = "2",
                             "Instagram"          = "3",
                             "Snapchat"           = "4",
                             "WhatsApp"           = "5",
                             "Skype"              = "6",
                             "Kik"                = "7",
                             "Vine"               = "8",
                             "Tumblr"             = "9",
                             "Pinterest"          = "10",
                             "Other"              = "11",
                             "Refuse to answer"   = "98",
                             "Skipped"            = "99"),
         S56_20 = fct_recode(as.factor(S56_20),
                             "Tinder"               = "1",
                             "Grindr"               = "2",
                             "Growler"              = "3",
                             "Jack'd"               = "4",
                             "Scruff"               = "5",
                             "Badoo"                = "6",
                             "Craigslist"           = "7",
                             "Plenty of Fish (POF)" = "8",
                             "Adam4Adam (A4a)"      = "9",
                             "Hinge"                = "10",
                             "Bumble"               = "11",
                             "Other"                = "12",
                             "Refuse to answer"     = "98",
                             "Skipped" = "99"),
         S56_23 = fct_recode(as.factor(S56_23),
                             "Every day, more than 1 hour" = "1",
                             "Every day, less than 1 hour" = "2",
                             "Almost every day"            = "3",
                             "A couple times a week"       = "4",
                             "Once a week"                 = "5",
                             "Less than once a week"       = "6",
                             "Never"                       = "7",
                             "Refuse to answer"            = "8"),
         S56_24XV = as.integer(S56_24XV))
```

```{r techSummary}
table3a <- bind_rows(
  table_ManyBinary(tech, n = 3, header = "Device Use", keep = "S56_1G",
                        variables = c("S56_1A" = "Cell Phone", 
                                      "S56_1B" = "Tablet", 
                                      "S56_1C" = "Other mobile device",
                                      "S56_1D" = "Laptop",
                                      "S56_1E" = "Desktop computer",
                                      "S56_1F" = "Other", 
                                      "S56_1G" = "No devices")),
  table_OneFactor(tech, n = 3, varString = "S56_4",
                       header = "Frequency of Sending/Receiving Texts",
                       keep = "Never") %>%
    add_row(Variable = "Text Messaging", .before = 1),
  table_OneFactor(tech, n = 3, varString = "S56_7",
                       header = "Frequency of Checking Email",
                       keep = "Never") %>%
    add_row(Variable = "Email", .before = 1)
)
table3b <- bind_rows(
  table_OneFactor(x = tech, n = 3, header = "SN Used Most Often",
                        varString = "S56_11"),
  table_OneFactor(tech, n = 3, header = "SN Use Frequency",
                       varString = "S56_13"),
  table_OneFactor(tech, n = 3, header = "PM Use Frequency",
                       varString = "S56_16",
                       keep = "Never") %>%
    add_row(Variable = "Private Messaging (PM) Apps", .before = 1),
  table_OneFactor(tech, n = 3, header = "Frequency of Other Uses of Internet",
                       varString = "S56_23",
                       keep = "Never") %>%
    add_row(Variable = "Use Internet Other Than Messaging, Email, Social Networking, Dating",
            .before = 1)
)
```

### Table 3a
```{r table3a, include = TRUE}
kable(table3a %>%
        filter(!is.na(Overall))) %>%
  kable_styling(bootstrap_options = c("striped", "condensed")) %>%
  group_rows("Device Use, N (%)", 1, 5) %>%
  group_rows("Text Messaging:\nFrequency of Sending/Receiving Texts, N (%)", 
             6, 10) %>%
  group_rows("Email:\nFrequency of Checking Email, N (%)", 11, 15)
```

### Table 3b
```{r table3b, include = TRUE}
kable(table3b %>%
        filter(!is.na(Overall))) %>%
  kable_styling(bootstrap_options = c("striped", "condensed")) %>%
  group_rows("SN Used Most Often, N (%)", 1, 4) %>%
  group_rows("SN Use Frequency, N (%)", 5, 8) %>%
  group_rows("PM Use Frequency, N (%)", 9, 13) %>%
  group_rows("Frequency of Other Uses of Internet", 14, 18)
```

```{r saveWorkbook, eval = FALSE}
wb <- loadWorkbook("DHSB Tables.xlsx")
#Table3a
removeWorksheet(wb, "Table 3a")
addWorksheet(wb, "Table 3a")
writeData(wb, sheet = "Table 3a", table3a)
setColWidths(wb, sheet = "Table 3a", cols = 1:ncol(table3a), widths = "auto")
#Table3b
removeWorksheet(wb, "Table 3b")
addWorksheet(wb, "Table 3b")
writeData(wb, sheet = "Table 3b", table3b)
setColWidths(wb, sheet = "Table 3b", cols = 1:ncol(table3b), widths = "auto")
saveWorkbook(wb, "DHSB Tables.xlsx", overwrite = TRUE)
```

