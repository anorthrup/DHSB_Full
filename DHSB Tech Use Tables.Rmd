---
title: "DHSB Technology Tables"
author: "Adam Northrup, Data Manager, ETAC"
date: "March 11, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
#####Read libraries
library(tidyverse)
library(sjlabelled)
library(rio)
library(openxlsx)
library(kableExtra)

#####Load data
setwd("C:/Users/ANorthrup/Documents/ETAC_DHSB")
load("acasi.RData")
```

```{r processData}
tech <- acasi2 %>%
  select(SITE1, SITE_RC, PID, starts_with("MTU"), starts_with("S56"))
```

```{r techSummaryFunction}
tableTech <- function (x, n, header, varStrings) { 
  ##varStings must be in same order as columns
  ##n = number of names to keep, rest will be lumped into 'Other'
  
  #Save variable names
  variables <- x %>%
    select(-SITE_RC) %>%
    names()
  #List responses in descending ranked order
  freqCols <- x %>% 
  select(-SITE_RC) %>%
  map_int(sum) %>%
  sort(., decreasing = TRUE) %>%
  names()
  #Combine lower ranked responses if there are more than (n + 1)
  if (length(freqCols) > (n + 1)){
    x <- x %>%
      mutate(Other = rowSums(select(., freqCols[(n + 1):length(freqCols)]))) %>%
      mutate(Other = if_else(Other > 0, 1L, 0L)) %>%
      select(SITE_RC, freqCols[1:n], Other)
    freqCols <- c(freqCols[1:n], "Other")
  }
  #Summarize responses overall and by site
  full_join(
    #Summarize overall
    x %>% 
      select(-SITE_RC) %>%
    {
      bind_cols(map_int(., sum) %>% 
                  as.data.frame() %>%
                  rownames_to_column("Variable"),
                map_dbl(., mean) %>%
                  as.data.frame())
    } %>%
      setNames(c("Variable", "Sum", "Mean")) %>%
      mutate(Mean = scales::percent(Mean, accuracy = 0.1)) %>%
      unite("Overall", Sum, Mean, sep = " (") %>%
      mutate(Overall = gsub("(.*)", "\\1)", Overall)),
    #Summarize by site
    x %>%
      group_by(SITE_RC) %>%
      summarize_all(funs(sum, mean)) %>%
      gather("Key", "Value", -SITE_RC) %>%
      {
        full_join(filter(., str_detect(Key, "_sum")) %>%
                    rename(Sum = Value) %>%
                    mutate(Key = gsub("_sum", "", Key)),
                  filter(., str_detect(Key, "_mean")) %>%
                    rename(Mean = Value) %>%
                    mutate(Key = gsub("_mean", "", Key)),
                  by = c("SITE_RC", "Key"))
      } %>%
      rename(Variable = Key) %>%
      mutate(Mean = scales::percent(Mean, accuracy = 0.1)) %>%
      unite("Value", Sum, Mean, sep = " (") %>%
      mutate(Value = gsub("(.*)", "\\1)", Value)) %>%
      spread(SITE_RC, Value),
    by = "Variable"
  ) %>%
    #Overwrite variable names with readable names
    mutate(Variable = c(
      varStrings[map_int(Variable[1:n], ~which(variables %in% .))],
      "Other")) %>%
    #Add header row
      {
        bind_rows(
          tribble(~Variable, ~Overall, ~`Corpus Christi`, ~`Los Angeles`,
                ~`New York`, ~Chicago, ~Cleveland, ~Hershey, ~Philadelphia,
                ~`San Francisco`, ~`Winston-Salem`, ~`St. Louis`,
                paste0(header, ", N (%)"), 
                NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
          select(., everything())
        )
      }
}
```

```{r techSummary}
table3 <- bind_rows(
  tableTech(tech %>%
              select(SITE_RC, matches("S56_1[[:alpha:]]+"), -S56_1S),
            n = 3, header = "Device Use",
            varStrings = c("Cell phone", "Tablet", "Other mobile device", 
                           "Laptop", "Desktop computer", "Other", 
                           "Not applicable"))
)
```

