---
title: "Digital Health-Seeking Behaviors Tables"
author: "Adam Northrup, Data Manager, ETAC"
date: "March 8, 2019"
output: html_document
---
```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
#####Read libraries
library(tidyverse)
library(sjlabelled)
library(rio)
library(openxlsx)
library(scales)
library(kableExtra)

#####Load data
load("acasi.RData")
source("DHSB Table Functions.R")
```

```{r}
#####Print "Other" text for each demographic variable
# wb <- createWorkbook()
# for (i in c("GENDERS", "RACEFS", "ORIENTS", "LIVED6LS", "STAY7DS", 
#            "INSUREHS", "SSNDOS", "CNEED3ES", "DISCJS")) {
#   addWorksheet(wb, i)
#   writeData(wb, i, acasi %>%
#               select(SITE1, PID, i) %>%
#               filter(!!sym(i) != "[Skipped]"))
# }
# saveWorkbook(wb, "ACASI Other Text.xlsx", overwrite = TRUE)

#####Format variables and rename
demo <- acasi2 %>%
  select(-EMPLOY, -RACE,
         -starts_with("DRUG"), -starts_with("MTU"), -starts_with("S56")) %>%
  mutate(`Age Groups` = as.factor(case_when(AGE < 25 ~ "18-24 Years",
                                            AGE >= 25 ~ "25-34 Years")),
         SCREEN5 = fct_recode(as.factor(SCREEN5),
                              "Within past 12 months" = "1", "More than 12 months ago" = "2",
                              "Don't know/Not sure"   = "7", "Refuse to answer"        = "8"),
         SEXBRTH = fct_recode(as.factor(SEXBRTH),
                              "Male" = "1", "Female" = "2", "Refuse to answer" = "8"),
         MONEY = ifelse(MONEY %in% c(99997, 99998), NA, MONEY)) %>%
  mutate_at(vars(JAILL), 
            funs(as.factor)) %>%
  mutate_at(vars(JAILL), 
            funs(fct_recode), "Yes" = "1", "No" = "0", "Don't know/Not sure" = "7", "Refuse to answer" = "8") %>%
  mutate_at(vars(contains("CARE"), -CARELHIV), funs(as.factor(case_when(. == 0   ~ "Yes",
                                                                        . <= 99  ~ "No",
                                                                        . >  99  ~ "Refuse to answer")))) %>%
  unite("SitePID", SITE_RC, PID, remove = FALSE) %>%
  arrange(SITE_RC, PID) %>%
  rename(Gender = GENDER_RC,
         `Sex at Birth` = SEXBRTH,
         `Sexual Orientation` = ORIENT_RC,
         `Relationship Status` = RELSTAT_RC,
         Education = GRADE_RC,
         `Income, Last Month` = MONEY,
         `Residence, Last 7 Days` = STAY7D_RC,
         `Ever Jailed` = JAILL,
         `Ethnicity and Race` = RACE_RC,
         `HIV Diagnosis` = SCREEN5)
```

```{r}
#####Table 1: participant characteristics summary
table1 <- bind_rows(
  #Number of participants
  bind_rows(
    demo %>%
      summarize(Frequency = n()) %>%
      mutate(SITE_RC = "Overall"),
    demo %>%
      group_by(SITE_RC) %>%
      summarize(Frequency = n()) %>%
      mutate(SITE_RC = as.character(SITE_RC))
  ) %>%
    mutate(Frequency = as.character(Frequency)) %>%
    spread(SITE_RC, Frequency) %>%
    mutate(Variable = "Number of Participants") %>%
    select(Variable, Overall, levels(demo$SITE_RC)),
  #Age groups
  table_OneFactor(demo, varString = "Age Groups",
                  varRelevel = c("18-24 Years")),
  #Ethnicity/Race
  table_OneFactor(demo, varString = "Ethnicity and Race", 
                  varRelevel = c("Latino",
                                 "Black, Not Latino",
                                 "White, Not Latino",
                                 "White Mixed-Race, Not Latino or Black")),
  #Sex at birth
  table_OneFactor(demo, varString = "Sex at Birth",
                  varRelevel = c("Male")),
  #Gender
  table_OneFactor(demo, varString = "Gender",
                  varRelevel = c("Male (cis man)",
                                 "Female (cis woman)",
                                 "Trans person")),
  #Orientation
  table_OneFactor(demo, varString = "Sexual Orientation",
                  varRelevel = c("Straight",
                                 "Gay or lesbian",
                                 "Bisexual")),
  #Education
  table_OneFactor(demo, varString = "Education", 
                  varRelevel = c("High school, equivalent or less",
                                 "Some post-K12")),
  #Employment
  table_OneFactor(demo, varString = "EMPLOY_RC", header = "Employment Status"),
  #Income
  bind_rows(
    demo %>%
      summarize(Metric = as.character(
        paste0(
          median(`Income, Last Month`, na.rm = TRUE), " [",
          paste(quantile(`Income, Last Month`, c(0.25, 0.75), na.rm = TRUE),
                collapse = ", "),
          "]"
        ))
      ) %>%
      mutate(SITE_RC = "Overall"),
    demo %>%
      group_by(SITE_RC) %>%
      summarize(Metric = as.character(
        paste0(
          median(`Income, Last Month`, na.rm = TRUE), " [",
          paste(quantile(`Income, Last Month`, c(0.25, 0.75), na.rm = TRUE),
                collapse = ", "),
          "]"
        ))
      ) %>%
      mutate(SITE_RC = as.character(SITE_RC))) %>%
    spread(SITE_RC, Metric) %>%
    mutate(Variable = "   Income") %>%
    select(Variable, Overall, levels(demo$SITE_RC)) %>%
    {
      bind_rows(
        tribble(~Variable, ~Overall, ~`Corpus Christi`, ~`Los Angeles`,
              ~`New York`, ~Chicago, ~Cleveland, ~Hershey, ~Philadelphia,
              ~`San Francisco`, ~`Winston-Salem`, ~`St. Louis`,
              "Income, Last Month, Median [IQR]", 
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
        select(., everything())
      )
    },
  #Residence
  table_OneFactor(demo, varString = "Residence, Last 7 Days", 
                  varRelevel = c("Rented house/apt/flat",
                                 "Other's house/apt/flat",
                                 "Hotel/Shelter/Rehab",
                                 "Hospital/Medical facility")),
  #Jailed
  table_OneFactor(demo, varString = "Ever Jailed", header = "Incarceration") %>%
    filter(Variable %in% c("   Yes", "Incarceration, N (%)")) %>%
    mutate(Variable = str_replace(Variable, "   Yes", "   Ever Jailed"))
)

#####Table 2: participant health care summary
table2 <- bind_rows(
  #HIV Diagnosis
  table_OneFactor(demo, varString = "HIV Diagnosis",
                  varRelevel = c("Within past 12 months",
                                 "More than 12 months ago")),
  #Insurance
  table_OneFactor(demo, varString = "INSURE_RC", header = "Insurance"),
  #Health care history, 6 months
  bind_rows(
    table_OneFactor(demo, header = "Recent Health Care",
                    varString = "CARED6") %>%
      filter(Variable != "   No") %>%
      mutate(Variable = replace(Variable, str_which(Variable, "Yes"), 
                                "   Doctor's visit, non-HIV, 6 months")),
    table_OneFactor(demo, header = "Recent Health Care",
                    varString = "CAREHV06") %>%
      filter(str_detect(Variable, "Refuse|Yes")) %>%
      arrange(desc(Variable)) %>%
      mutate(Variable = replace(Variable, str_which(Variable, "Yes"), 
                                "   Doctor's visit, HIV, 6 months"),
             Variable = replace(Variable, str_which(Variable, "Refuse"),
                                                    "      Refuse to answer"))
    )  %>%
    add_row(Variable = "Viral Load, Median [IQR]") %>%
    add_row(Variable = "Viral Load"),
  #Relationship Status
  table_OneFactor(demo, varString = "Relationship Status", 
                  varRelevel = c("Single",
                                 "Dating",
                                 "Partnered/Married"))
)
```
Note that responses from participants with no baseline survey were replaced with 6 month survey. "Past 6 months" refers to 6 months prior to 6 month survey. If no data was available for a given question (participant had no baseline survey, and question wasn't asked in 6 month survey), the participant was not included in the denominator.  

### Table 1
```{r include = TRUE}
kable(table1 %>%
        filter(!is.na(Overall)),
      caption = 
        "Table 1. Sociodemographic characteristics of youth and young people living with HIV"
      ) %>%
  kable_styling(bootstrap_options = c("striped", "condensed")) %>%
  group_rows("Age Group, N (%)", 2, 3) %>%
  group_rows("Ethnicity and Race, N (%)", 4, 8) %>%
  group_rows("Sex at Birth, N (%)", 9, 10) %>%
  group_rows("Gender, N (%)", 11, 14) %>%
  group_rows("Sexual Orientation, N (%)", 15, 18) %>%
  group_rows("Education, N (%)", 19, 21) %>%
  group_rows("Employment, N (%)", 22, 23) %>%
  group_rows("Income, Median [IQR]", 24, 24) %>%
  group_rows("Residence, Last 7 Days, N (%)", 25, 31) %>%
  group_rows("Incarceration, N (%)", 32, 32)
```

### Table 2
```{r include = TRUE}
kable(table2 %>%
        filter(!is.na(Overall)),
      caption = "Table 2. HIV-related health, healthcare utilization, and other characteristics that may relate to digital health seeking"
      ) %>%
  kable_styling(bootstrap_options = c("striped", "condensed")) %>%
  group_rows("HIV Diagnosis, N (%)", 1, 4) %>%
  group_rows("Insurance, N (%)", 5, 7) %>%
  group_rows("Recent Health Care, N (%)", 8, 10) %>%
  group_rows("Relationship Status, N (%)", 11, 15) %>%
  add_indent(c(10))
```

```{r eval = FALSE}
wb <- loadWorkbook("DHSB Tables.xlsx")
#Table 1
removeWorksheet(wb, "Table 1")
addWorksheet(wb, "Table 1")
writeData(wb, sheet = "Table 1", table1)
setColWidths(wb, sheet = "Table 1", cols = 1:ncol(table1), widths = "auto")
#Table 2
removeWorksheet(wb, "Table 2")
addWorksheet(wb, "Table 2")
writeData(wb, sheet = "Table 2", table2)
setColWidths(wb, sheet = "Table 2", cols = 1:ncol(table2), widths = "auto")

saveWorkbook(wb, "DHSB Tables.xlsx", overwrite = TRUE)
```

