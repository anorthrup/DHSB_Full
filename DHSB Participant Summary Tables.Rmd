---
title: "Digital Health-Seeking Behaviors Tables"
author: "Adam Northrup, Data Manager, ETAC"
date: "June 19, 2019"
output: html_document
---
```{r include = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE, 
                      warning = FALSE, message = FALSE)
#####Read libraries
library(tidyverse)
library(sjlabelled)
library(rio)
library(openxlsx)
library(scales)
library(kableExtra)

#####Load data
# setwd("C:/Users/anorthrup/Box Sync/ETAC")
load("acasi.RData")
source("DHSB Table Functions.R")
```

```{r}
#####Print "Other" text for each demographic variable
# wb <- createWorkbook()
# for (i in c("GENDERS", "RACEFS", "ORIENTS", "LIVED6LS", "STAY7DS", 
#            "INSUREHS", "SSNDOS", "CNEED3ES", "DISCJS")) {
#   addWorksheet(wb, i)
#   writeData(wb, i, acasi %>%
#               select(SITE1, PID, i) %>%
#               filter(!!sym(i) != "[Skipped]"))
# }
# saveWorkbook(wb, "ACASI Other Text.xlsx", overwrite = TRUE)

#####Format variables and rename
demo <- acasi %>%
  filter(Set == 1) %>% #Remove participants without 06m assessment
  filter(!(is.na(HE_RC_HAL) | is.na(HE_RC_HSE))) %>%
  select(-RACE, -starts_with("S56")) %>%
  filter(!(is.na(HE_RC_HSE) | is.na(HE_RC_HAL))) %>%
  mutate(`Age Groups` = as.factor(case_when(AGE < 25 ~ "18-24 Years",
                                            AGE >= 25 ~ "25-34 Years")),
         SCREEN5 = fct_recode(as.factor(SCREEN5),
                              "Within past 12 months" = "1", "More than 12 months ago" = "2",
                              "Don't know"   = "7", "Refuse to answer"        = "8"),
         ViralSupp_MCD = fct_recode(as.factor(ViralSupp_MCD),
                                    "Not suppressed" = "0",
                                    "Suppressed"     = "1"),
         DISC_RC = if_else(DISCA == 0, "Disclosed", "Did not disclose"),
         DRUG_RCD_None = if_else(DRUG1LM == 1 & DRUG2LK == 1, 1, 0)) %>%
  # mutate_at(vars(matches("(CARE)([[:alpha:]]+)(\\d+)")),
  #           list(~as.factor(case_when(. == 0  ~ "No",
  #                                     . <= 98 ~ "Yes",
  #                                     . >= 98 ~ "Missing")))) %>%
  mutate(INJECTL_RC = case_when(INJECTL == 1 ~ "Injected drugs",
                                INJECTL == 0 ~ "Did not inject drugs")) %>%
  unite("SitePID", SITE_RC, PID, remove = FALSE) %>%
  arrange(SITE_RC, PID) %>%
  mutate_at(vars(matches("DISC_RCD|DRUG_RCD")), list(~as.numeric(as.character(.))))
```

```{r}
#####Number of participants
newNames <- bind_rows(
  demo %>%
    summarize(Frequency = n()) %>%
    mutate(SITE_RC = "Overall_1"),
  demo %>%
    group_by(SITE_RC) %>%
    summarize(Frequency = n()) %>%
    mutate(SITE_RC = as.character(SITE_RC))
) %>%
  unite("NewNames", SITE_RC, Frequency, sep = " (N=", remove = FALSE) %>%
  mutate(NewNames = str_c(NewNames, ")")) %>%
  select(-Frequency) %>%
  mutate(NewNames = factor(NewNames, levels = unique(NewNames))) %>%
  spread(NewNames, SITE_RC) %>%
  unlist()
#####Table 1: participant characteristics summary
table1 <- bind_rows(
  #Age groups
  table_OneFactor(demo, varString = "Age Groups",
                  varRelevel = c("18-24 Years")),
  #Ethnicity/Race
  table_OneFactor(demo, varString = "RACE_RC", header = "Ethnicity and Race", 
                  varRelevel = c("Latino",
                                 "Black, Not Latino",
                                 "White, Not Latino",
                                 "White Mixed-Race, Not Latino or Black")),
  #Gender
  table_OneFactor(demo, varString = "GENDER_RC", header = "Gender Identity",
                  varRelevel = c("Male (cis man)",
                                 "Female (cis woman)",
                                 "Trans-identified")),
  #Orientation
  table_OneFactor(demo, varString = "ORIENT_RC", header = "Sexual Orientation",
                  varRelevel = c("Straight",
                                 "Gay or lesbian",
                                 "Bisexual")),
  #Education
  table_OneFactor(demo, varString = "GRADE_RC", header = "Education",
                  varRelevel = c("High school, equivalent or less",
                                 "Some post-K12")),
  #Residence
  table_OneFactor(demo, varString = "STAY7D_RC", 
                  header = "Current Residence",
                  varRelevel = c("Stable housing")),
  #Income
  table_Continuous(demo, variable = "MONEY_RC", stat = "median", 
                   name = "Income, Last Month")
) %>%
  mutate(Variable = str_replace(Variable, "(Income, Last Month)(.*)", "\\1")) %>%
  mutate(Overall = str_replace(Overall, "(\\d+)(/\\d+)(.*)", "\\1\\3")) %>%
  mutate_at(vars(-Header, -Variable, -Overall),
            list(~str_replace(., "(.*)(\\d \\()(.*)(%\\)$)", "\\3"))) %>%
  mutate_at(vars(-Header, -Variable, -Overall),
            list(~str_replace(., "(\\d+)( \\[.*\\]$)", "\\1"))) %>%
  separate(Overall, c("Overall_1", "Overall_2"), sep = " ") %>%
  mutate(Overall_2 = str_replace(Overall_2, "(\\()(.*)(%\\))", "\\2")) %>%
  add_row(Header = "Characteristic (Categorical)", 
          Variable = "Characteristic (Categorical)", 
          .before = 1) %>%
  mutate(Overall_1 = replace(Overall_1, 
                             which(Variable == "Characteristic (Categorical)"),
                             "n")) %>%
  mutate_at(vars(-Header, -Variable, -Overall_1), list(~replace(., 1, "%"))) %>%
  mutate_at(vars(Header, Variable), list(~str_remove(., ", N \\(%\\)"))) %>%
  add_row(.before = nrow(.) - 1, 
          Header = "Characteristic (Continuous)",
          Variable = "Characteristic (Continuous)") %>%
  mutate(Overall_2 = replace(Overall_2, 
                             which(Variable == "Characteristic (Continuous)"),
                             "IQR")) %>%
  mutate_at(vars(-Header, -Variable, -Overall_2), 
            list(~replace(., which(Variable == "Characteristic (Continuous)"), "med"))) %>%
  rename(!!newNames) %>%
  add_row(Variable = "STAY7D_RC: Six participants in 'Institution' (hospital or prison) were incorporated into 'Unstable housing'.") %>%
  add_row(Variable = paste0("MONEY_RC Overall sample size N=", length(which(!is.na(demo$MONEY_RC)))))

#####Table 2: participant health care summary
table2 <- bind_rows(
  bind_rows(
    #HIV Diagnosis
    table_OneFactor(demo, varString = "SCREEN5", header = "HIV Diagnosis",
                    varRelevel = c("Within past 12 months",
                                   "More than 12 months ago")),
    #Viral Suppression
    table_OneFactor(demo, varString = "ViralSupp_MCD",
                    header = "Viral Suppression") %>%
      filter(Variable != "   Not suppressed"),
    #Insurance
    table_OneFactor(demo, varString = "INSURE_RC", header = "Insurance"),
    #Health care history, 6 months
    bind_rows(
      table_OneFactor(demo, varString = "CARED6_RC", 
                      header = "Recent Health Care") %>%
        filter(Variable != "   No") %>%
        mutate(Variable = replace(Variable, str_which(Variable, "Yes"), 
                                  "   Doctor's visit, non-HIV, 6 months")),
      table_OneFactor(demo, varString = "CAREHV06_MCD_RC", 
                      header = "Recent Health Care") %>%
        filter(str_detect(Variable, "Yes")) %>%
        arrange(desc(Variable)) %>%
        mutate(Variable = replace(Variable, str_which(Variable, "Yes"), 
                                  "   Doctor's visit, HIV, 6 months"))
    ),
    #HIV Disclosure
    table_OneFactor(demo, varString = "DISC_RC", 
                    header = "HIV disclosure status") %>%
      filter(Variable != "   Did not disclose"),
    #Substance Use
    bind_rows(
      table_ManyBinary(demo, header = "Substance Use",
                       variables = c(
                         "DRUG_RCD_None"      = "None",
                         "DRUG_RCD_Alcohol"   = "Alcohol",
                         "DRUG_RCD_Tobacco"   = "Tobacco",
                         "DRUG_RCD_Marijuana" = "Marijuana",
                         "DRUG_RCD_Other"     = "Other non-injected drug(s)"
                       )),
      table_OneFactor(demo, varString = "INJECTL_RC", header = "Substance Use") %>%
        filter(Variable == "   Injected drugs")
    )
  ) %>%
    mutate_at(vars(-Header, -Variable, -Overall),
              list(~str_replace(., "(.*)(\\d \\()(.*)(%\\)$)", "\\3"))) %>%
    separate(Overall, c("Overall_1", "Overall_2"), sep = " ") %>%
    mutate(Overall_2 = str_replace(Overall_2, "(\\()(.*)(%\\))", "\\2")) %>%
    add_row(Header = "Characteristic (Categorical)", 
            Variable = "Characteristic (Categorical)", 
            .before = 1) %>%
    mutate(Overall_1 = replace(Overall_1, 
                               which(Variable == "Characteristic (Categorical)"),
                               "n")) %>%
    mutate_at(vars(-Header, -Variable, -Overall_1), list(~replace(., 1, "%"))),
  bind_rows(
    #Youth Health Engagement
    #> Health Access Literacy
    table_Continuous(demo, variable = "HE_RC_HAL",
                     name = "Health Access Literacy", 
                     header = "Youth Health Enagement"),
    #> Health Self-Efficacy
    table_Continuous(demo, variable = "HE_RC_HSE", 
                     name = "Health Self-Efficacy"),
    #Provider Empathy
    table_Continuous(demo, variable = "CARE_RC",
                     name = "Provider Empathy", 
                     header = "Provider Empathy"),
    #Social Support
    table_Continuous(demo, variable = "SOCIALS_RC",
                     name = "Social Support", 
                     header = "Social Support"),
    #HIV-Related Stigma
    table_Continuous(demo, variable = "STIGMA_RC",
                     name = "HIV-Related Stigma", 
                     header = "HIV-Related Stigma"),
    #Physical and Mental Health
    table_Continuous(demo, variable = "MENTALH_RC",
                     name = "Mental Health",
                     header = "Physical and Mental Health")
    # table_Continuous(demo, variable = "MENTALH4",
    #                  name = "Mental and Physical Health, 1 item")
  ) %>%
    mutate_at(vars(-Header, -Variable, -Overall),
              list(~str_replace(., "(.*)(\\d+)( \\(.*\\)$)", "\\1\\2"))) %>%
    separate(Overall, c("Overall_1", "Overall_2"), sep = " ") %>%
    add_row(Header = "Characteristic (Categorical)", 
            Variable = "Characteristic (Categorical)", 
            .before = 1) %>%
    mutate(Overall_2 = replace(Overall_2, 
                               which(Variable == "Characteristic (Categorical)"),
                               "(SD)")) %>%
    mutate_at(vars(-Header, -Variable, -Overall_2), list(~replace(., 1, "m")))
) %>%
  mutate(Overall_1 = str_replace(Overall_1, "(\\d+)(/\\d+)", "\\1")) %>%
  mutate_at(vars(Header, Variable), list(~str_remove(., ", N \\(%\\)"))) %>%
  mutate_at(vars(Header, Variable), list(~str_remove(., ", Mean \\(SD\\)"))) %>%
  rename(!!newNames)
save(table1, table2, file = "Tables Participants.RData")
```

### Table 1
```{r include = TRUE}
kable(table1 %>%
        filter(!is.na(Overall)),
      caption = 
        "Table 1. Sociodemographic characteristics of young adults living with HIV"
      ) %>%
  kable_styling(bootstrap_options = c("striped", "condensed")) %>%
  group_rows("Age Group, N (%)", 2, 3) %>%
  group_rows("Ethnicity and Race, N (%)", 4, 8) %>%
  group_rows("Gender Identity, N (%)", 9, 12) %>%
  group_rows("Sexual Orientation, N (%)", 13, 16) %>%
  group_rows("Education, N (%)", 17, 19) %>%
  group_rows("Income, Median [IQR]", 20, 20) %>%
  group_rows("Residence, Last 7 Days, N (%)", 21, 22)
```
Footnotes:  

* STAY7D_RC: Six participants in 'Institution' (hospital or prison) were incorporated into 'Unstable housing'.

### Table 2
```{r include = TRUE}
kable(table2 %>%
        filter(!is.na(Overall)),
      caption = "Table 2. HIV-related health, healthcare utilization, and other characteristics that may relate to digital health seeking"
      ) %>%
  kable_styling(bootstrap_options = c("striped", "condensed")) %>%
  group_rows("HIV Diagnosis [Max Value], N (%)", 1, 3) %>%
  group_rows("Viral Suppression [Max Value], N (%)", 4, 4) %>%
  group_rows("Insurance [Max Value], N (%)", 5, 7) %>%
  group_rows("Recent Health Care [Max Value], N (%)", 8, 9) %>%
  group_rows("Youth Health Enagement [Max Value], Mean (SD)", 10, 11) %>%
  group_rows("Provider Empathy [Max Value], Mean (SD)", 12, 12) %>%
  group_rows("Social Support [Max Value], Mean (SD)", 13, 13) %>%
  group_rows("HIV-Related Stigma [Max Value], Mean (SD)", 14, 14) %>%
  group_rows("Disclosure of HIV Status, N (%)", 15, 18) %>%
  group_rows("Physical and Mental Health [Max Value], Mean (SD)", 19, 20) %>%
  group_rows("Substance Use, N (%)", 21, 26) %>%
  group_rows("Media and Technology Use and Attitudes Subscales [Max Value], Mean (SD)", 27, 37)
```

```{r eval = FALSE}
wb <- loadWorkbook("DHSB Tables.xlsx")
#Table 1
removeWorksheet(wb, "Table 1")
addWorksheet(wb, "Table 1")
writeData(wb, sheet = "Table 1", table1)
setColWidths(wb, sheet = "Table 1", cols = 1:ncol(table1), widths = "auto")
#Table 2
removeWorksheet(wb, "Table 2")
addWorksheet(wb, "Table 2")
writeData(wb, sheet = "Table 2", table2)
setColWidths(wb, sheet = "Table 2", cols = 1:ncol(table2), widths = "auto")

saveWorkbook(wb, "DHSB Tables.xlsx", overwrite = TRUE)
```

### Testing Across Sites
```{r include = TRUE}
table1Chisq <- table1 %>%
  mutate_at(vars(-Variable), list(~as.integer(str_extract(., "(\\d+)"))))
table2Chisq <- table2 %>%
  mutate_at(vars(-Variable), list(~as.integer(str_extract(., "(\\d+)"))))
bind_rows(
  chisq.dhsb(table1Chisq, "Age Group", 
             c("   18-24 Years", "   25-34 Years")),
  chisq.dhsb(table1Chisq, "Ethnicity and Race", 
             c("   Latino", 
               "   Black, Not Latino",
               "   White, Not Latino")),
  chisq.dhsb(table1Chisq, "Gender Identity", 
             c("   Male (cis man)", 
               "   Female (cis woman)",
               "   Trans-identified",
               "   Other gender")),
  chisq.dhsb(table1Chisq, "Sexual Orientation", 
             c("   Straight",
               "   Gay or lesbian",
               "   Bisexual",
               "   Other orientation")),
  chisq.dhsb(table1Chisq, "Education", 
             c("   High school, equivalent or less",
               "   Some post-K12",
               "   College graduate or trade certification")),
  chisq.dhsb(table1Chisq, "Residence, Last 7 Days",
             c("   Stable housing",
               "   Unstable housing",
               "   Institution"))
) %>%
  mutate(Warning = c("No", "Yes", "Yes", "Yes", "Yes", "Yes")) %>%
  kable(., digits = 3,
        caption = "Chi-Square Testing for Categorical Variables Across Site") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
bind_rows(
  anova.dhsb(demo, "MONEY_RC_Log", "Income, Last Month"),
  anova.dhsb(demo, "HE_RC_HAL", "Health Access Literacy"),
  anova.dhsb(demo, "HE_RC_HSE", "Health Self-Efficacy"),
  anova.dhsb(demo, "CARE_RC", "Provider Empathy"),
  anova.dhsb(demo, "MENTALH_RC", "Mental Health"),
  anova.dhsb(demo, "MENTALH4_RC", "Physical and Mental Health"),
  anova.dhsb(demo, "MTUEX_RC", "Email Usage"),
  anova.dhsb(demo, "MTUSPX_RC_Text", "Text Messaging"),
  anova.dhsb(demo, "MTUSPX_RC_Smartphone", "Smartphone Usage"),
  anova.dhsb(demo, "MTUIX_RC", "Internet Searching"),
  anova.dhsb(demo, "MTUSNX_RC", "General Social Media Usage"),
  anova.dhsb(demo, "MTUAX_RC_Pos", "Positive Attitudes Toward Technology"),
  anova.dhsb(demo, "MTUAX_RC_Anx", "Anxiety About Being Without Technology or Dependence on Technology"),
  anova.dhsb(demo, "MTUAX_RC_Neg", "Negative Attitudes Toward Technology")
) %>%
  kable(., digits = 3,
        caption = "ANOVA Testing for Continuous Variables Across Site") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))

```
